#!/usr/bin/env bash
# Pre-commit hook to prevent secrets from being committed
# Install: cp .githooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-commit security checks...${NC}"

# Check for .env files being committed
if git diff --cached --name-only | grep -E '\.env\.local|\.env\.production|secrets' > /dev/null; then
    echo -e "${RED}❌ ERROR: Attempting to commit environment/secrets files!${NC}"
    echo -e "${RED}The following files cannot be committed:${NC}"
    git diff --cached --name-only | grep -E '\.env|secrets' || true
    echo -e "${YELLOW}These files are protected by .gitignore${NC}"
    exit 1
fi

# Check for common secret patterns in staged changes
FORBIDDEN_PATTERNS=(
    "NEXTAUTH_SECRET\s*=\s*[A-Za-z0-9+/]"
    "MONGODB_URI\s*=\s*mongodb"
    "GOOGLE_CLIENT_SECRET\s*=\s*"
    "CLOUDINARY_API_SECRET\s*=\s*"
    "INNGEST_SIGNING_KEY\s*=\s*"
    "API_KEY\s*=\s*[A-Za-z0-9]"
)

for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
    if git diff --cached -U0 | grep -E "$pattern" > /dev/null; then
        echo -e "${RED}❌ ERROR: Potential secret detected in staged changes!${NC}"
        echo -e "${RED}Pattern matched: $pattern${NC}"
        echo -e "${YELLOW}Secrets must be stored in environment variables or secrets manager${NC}"
        echo -e "${YELLOW}Use .env.example for safe template values${NC}"
        exit 1
    fi
done

echo -e "${GREEN}✅ Security checks passed${NC}"
exit 0
